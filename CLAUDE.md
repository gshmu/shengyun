# Shengyun 声韵输入方案 - 开发文档

## 项目概述

Shengyun（声韵拼音）是基于 RIME/Trime 的声韵分层拼音输入方案，通过将汉语拼音分为声母和韵母两层键盘，实现两步输入完整拼音的创新交互方式。

**项目类型**：纯输入方案（YAML 配置文件），无需编译 APK
**目标用户**：学习拼音的孩子
**依赖**：官方 Trime 输入法 + RIME 引擎
**许可证**：GPL-3.0-or-later

---

## 开发环境配置

### 网络代理设置

项目开发过程中如需访问外部资源，可配置代理：
**代理地址**：`100.64.0.239:7897`（支持 HTTP/HTTPS/SOCKS）

### 技术栈

- **RIME**：中州韵输入法引擎（librime）
  - 拼音处理、词库匹配、候选词生成
  - YAML 配置驱动

- **Trime**：同文输入法（Android 前端）
  - 键盘渲染、触摸事件处理
  - 调用 RIME 引擎 JNI 接口

- **配置语言**：YAML
  - `schema.yaml`：输入法逻辑
  - `trime.yaml`：键盘布局

## 韵母层键盘布局设计

### 设计原则

1. **无重复原则**：每个韵母在键盘上只出现一次
2. **关联性原则**：垂直列对应关系，便于记忆
3. **互补分布**：uan/üan、un/ün 共用位置（不同声母层显示不同）
4. **层次结构**：
   - 列1垂直：er → i → u → ü（基础元音）
   - 行1隔列：er, a, 空, o, 空, e（单韵母aoe隔列显示）
   - 行2列2：ai（固定位置）
   - 行4底部：ang, eng, ing, ong（后鼻音）

**设计原则**：
- **如实显示韵母本身**：韵母层显示韵母的实际发音形式（ü/ün/üe/üan）
- **输入码遵循 RIME 规范**：所有 ü 统一用 v 表示
- **与书写规则无关**：不考虑声韵组合后的书写变化（如 ju 书写时省略 ü 上的两点）

### 声母专用韵母层规则

**左上角(1,1)显示规则**：
- **通用层**：显示"er"并可点击
- **声母层**：显示当前声母（如"b"、"zh"），不可点击，纯提示作用

**标签显示规则**：
- 所有韵母按键只显示韵母部分（如"a"、"an"、"ang"）
- **j/q/x/y 层特殊规则**：如实显示 ü 系韵母（ü/ün/üe/üan）
- **其他声母层**：互补分布（ün→un, üan→uan）

**输入码规则**：
- 所有 ü 系韵母统一用 v 表示（RIME 标准）
- j/q/x/y 层：jv/jvn/jve/jvan（显示 ü/ün/üe/üan）
- 其他声母层：lv/lun/luan（显示 ü/un/uan）

## 项目历史

### 2025-11-16 - v1.0.2
- ✅ 修复 ün/üan 互补分布规则
  - CSV 更新：uan → üan（行4列7）
  - 修正 l 的韵母屏蔽：移除不存在的 lua/len/liong/lün/lüe
  - 修正 n 的韵母屏蔽：移除 ün（nun 不常用）
- ✅ 实现正确的互补分布显示
  - j/q/x/y 层：如实显示 ü/ün/üe/üan，输入 jv/jvn/jve/jvan
  - 其他声母层：显示 un/uan，输入 Xun/Xuan（如 lun/luan）
- ✅ 完善韵母层生成脚本
  - 同时生成 24 个声母层 + 通用韵母全览层 + 零声母层
  - 修正 convert_final_for_click() 和 convert_label_for_display() 函数
  - 所有 ü 系韵母输入码统一使用 v（RIME 标准）
- ✅ 设计原则确立：**如实显示韵母本身，与书写规则无关**
  - 韵母层显示韵母的实际发音形式
  - 输入码遵循 RIME 规范（v=ü）
  - 不考虑声韵组合后的书写变化

### 2025-11-16 - v1.0.1
- ✅ 修复关键声韵组合缺失 bug
  - l + iang (两、亮、量)
  - n + iang/in/uan/ong/ui (娘、您、暖、农)
  - c/s + en (层、森)
  - y + in (因)
- ✅ 修正 y/w 假声母配置
  - y: 正确配置 i系和ü系 + 单独韵母 (yi, ya, ye, yao, you, yan, yang, yin, ying, yong, yu, yue, yun, yuan)
  - w: 正确配置 u系 + 单独韵母 (wu, wa, we, wai, wei, wan, wang, weng, wen)
- ✅ 更新 author 信息：gshmu (https://gshmu.com)
- ✅ 优化文档：添加版本管理最佳实践（使用 Git 而非 .backup 文件）
- ✅ 更新 schema.yaml 描述：明确 y/w 为"假声母"，零声母特指不含声母和假声母的独立韵母

### 2025-11-15 - v1.1.1
- ✅ 声母层第一行支持常用标点输入
  - 短按：输入标点（：、？！，。）
  - 长按：输入数字（5-9, 0）
  - 标点按频率排序：。> ，> ！> ？> 、> ：
  - 保留数字 1-4（纯数字输入）

### 2025-11-15 - v1.1.0
- ✅ 实现配置驱动的韵母层生成系统（finals_mask_config.yaml）
- ✅ 修复 ün/un 互补分布显示规则
- ✅ 修复 j/q/x 层 ü 标签显示（ü→u，符合拼音书写标准）
- ✅ 移除重复的 u 按钮（j/q/x 只保留 ü 位置）
- ✅ 优化脚本：使用标记而非行号分割文件
- ✅ 提交 Trime 功能请求：事件驱动键盘切换（issue #1812）
- ✅ 发布 GitHub Release v1.1.0

### 2025-11-14 - v1.0.0
- ✅ 完成汉语拼音系统全面研究（23声母+39韵母）
- ✅ 建立声韵组合规则矩阵
- ✅ 验证复杂拼音输入（liang, zhang, ju 等）
- ✅ 实现自动键盘切换机制
- ✅ 实现智能过滤（erase 规则）
- ✅ 纯拼音界面设计（移除汉字助记）
- ✅ 完成完整文档（README + CLAUDE.md）
- ✅ 创建独立 GitHub 仓库（shengyun）

---

## Lua 自动键盘切换失败记录（已废弃）

**时间**: 2025-11-15
**错误**: `LuaProcessor::ProcessKeyEvent error(2): attempt to call a nil value`
**结论**: 无法定位根本原因，已放弃 Lua 方案，改用纯 Trime 配置。

---

**Claude Code 项目文档** | 声韵输入方案 | Updated: 2025-11-15
